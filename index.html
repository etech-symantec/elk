<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELK logstash.conf ìƒì„±ê¸°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fa; --fg:#222; --muted:#6b7280; --card:#ffffff; --pri:#1e3a8a; --pri2:#0ea5e9; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --radius:16px; --pad:14px; --shadow:0 6px 22px rgba(0,0,0,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    
    .dongle-regular {
        font-family: "Dongle", sans-serif;
        font-weight: 400;
        font-style: normal;
      }
    
      /* ğŸ”¹ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
      .top-nav {
        display: flex; justify-content: flex-end; gap: 5px; margin-bottom: -10px;
      }
      .nav-btn {
        background: #1e3a5f; color: white; border: none; border-radius: 8px;
        padding: 4px 10px; height: 26px; line-height: 18px;
        cursor: pointer; font-weight: 600; font-size: 0.75rem;
        text-decoration: none; transition: background 0.2s;
      }
      .nav-btn:hover { background: #294b7a; }
    
    body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 20px 40px 40px 40px;
        color:#333;
      }
    header{display:flex; align-items:center; justify-content:space-between; padding:24px 28px; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(180deg, rgba(245,247,250,.9), rgba(245,247,250,.65)); border-bottom:1px solid #e5e7eb; z-index:5}
    h1 {
        font-size: 1.5em;
        background: #1e3a5f;
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 10pt;
      }
    .header-wrap {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #f3f4f6;
        transition: all 0.25s ease;
        padding-bottom: 0px;
      }
      
      .title-left {
        font-size: 1.6em;
        line-height: 0.7;
        margin-bottom: 0;
      }
    
      .subtitle {
        font-size: 0.7em;
        font-weight: normal;
        color: #bcd0f7;
        opacity: 0.9;
        margin-top: 2px;
        display: block;
      }
    
      .date-container {
        text-align: right;
        line-height: 1.2;
      }
    
      .version {
        font-size: 20px;
        color: #bcd0f7;
        opacity: 0.9;
      }
    
      .container {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        margin: 20px 0 0 0;
        padding: 18px 24px 24px 24px;
      }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{border:none; border-radius:12px; padding:8px 14px; background:var(--pri); color:#fff; cursor:pointer; box-shadow:var(--shadow); font-weight:600; font-size:13px}
    .btn:hover {
      background: #1e293b;       /* ğŸ”¹ hover ìƒ‰ìƒ ê°•ì¡° */
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    
    .btn:active {
      background: #0f172a;
      transform: translateY(0);
      box-shadow: 0 1px 5px rgba(0,0,0,0.15);
    }
    .btn.sec {
      background: #ff;
      color: #ffffff;
      border: 1px solid #1e293b;
      padding: 4px 10px;        /* ğŸ”¹ ë” ì‘ì€ ë²„íŠ¼ */
      font-size: 12px;          /* ğŸ”¹ ê¸€ì”¨ë„ ì•½ê°„ ì¤„ì„ */
      border-radius: 8px;       /* ğŸ”¹ ê°ì§„ ëŒ€ì‹  ì¡°ê¸ˆ ë” ê·€ì—¬ìš´ ë¼ìš´ë“œ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);  /* ğŸ”¹ ì‚´ì§ ì…ì²´ê° */
      transition: 0.15s ease;   /* ğŸ”¹ hover ì‹œ ë¶€ë“œëŸ½ê²Œ */
    }
    
    .btn.sec:hover {
      background: #1e293b;       /* ğŸ”¹ hover ìƒ‰ìƒ ê°•ì¡° */
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    
    .btn.sec:active {
      background: #0f172a;
      transform: translateY(0);
      box-shadow: 0 1px 5px rgba(0,0,0,0.15);
    }

    .btn.ghost{background:transparent; color:var(--pri); border:1px solid #bfdbfe; box-shadow:none}
    main{padding:24px; display:flex; flex-direction:column; gap:18px; max-width:1200px; margin:0 auto 32px auto;}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad)}
    .title{font-weight:700; margin:0 0 8px 0}
    .help{color:var(--muted); font-size:12px}
    label{display:block; font-weight:600; margin:10px 0 6px 0}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; border:1px solid #e5e7eb; background:#fff; border-radius:12px; padding:8px 10px; outline:none; font-family:inherit; font-size:13px;
    }
    textarea{font-family:var(--mono); min-height:40px; resize:vertical;}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .list{display:flex; flex-direction:column; gap:10px}
    .idx{border:1px solid #e5e7eb; border-radius:14px; padding:10px; background:#f9fafb;}
    .idx h4{margin:0 0 8px 0; font-size:14px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .grid5{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:4px;
    }
    .divider{height:1px; background:#e5e7eb; margin:12px 0}
    .table{border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; margin-top:6px}
    .table table{width:100%; border-collapse:collapse; font-size:12px}
    .table thead{background:#f8fafc}
    .table th, .table td{padding:6px 8px; border-bottom:1px solid #eef2f7; text-align:left}
    .codebox{
      background:#0b1020;
      color:#e2e8f0;
      border-radius:14px;
      padding:14px;
      min-height:260px;
      font-family:var(--mono);
      
      /* ê¸°ì¡´ value */
      white-space: pre-wrap;   /* â† ìë™ ì¤„ë°”ê¿ˆ */
      word-break: break-all;   /* â† ë„ˆë¬´ ê¸´ ë‹¨ì–´ëŠ” ê°•ì œë¡œ ì¤„ë°”ê¿ˆ */
      overflow-x: hidden;      /* â† ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° */
    }
    .chip{display:inline-flex; align-items:center; gap:6px; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:999px; padding:4px 10px; font-size:12px}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    
    /* type ì¹´ë“œ ì ‘ê¸°/í´ê¸°ìš© */
    .type-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      margin-bottom:6px;
    }
    .type-card-header h4{
      margin:0;
      font-size:14px;
    }
    .type-card-body{
      margin-top:4px;
    }
    .type-card.collapsed .type-card-body{
      display:none;
    }
    
    /* ê¶Œì¥ ë§¤í•‘ ëª¨ë‹¬ */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal {
      background:#fff;
      border-radius:16px;
      padding:16px 18px;
      max-width:640px;
      width:90%;
      max-height:80vh;     /* ì¶”ê°€ */
      overflow-y:auto;     /* ì¶”ê°€ */
      box-shadow:0 18px 45px rgba(15,23,42,.5);
      font-size:13px;
    }

    .modal h3{
      margin:0 0 8px 0;
      font-size:15px;
    }
    .modal table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
    }
    .modal th, .modal td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:left;
      font-size:12px;
    }
    .modal-footer{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }
    .grok-toggle-btn {
      font-size: 11px;
      padding: 3px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #f1f5f9;
      color: #334155;
      cursor: pointer;
      margin: 6px 0;
    }
    
    .grok-toggle-btn:hover {
      background: #e2e8f0;
    }
    
    /* ìƒ‰ìƒ í•˜ì´ë¼ì´íŠ¸ */
    .c-block {
      color: #60a5fa; /* íŒŒë€ìƒ‰ */
      font-weight: 700;
    }
    .c-key {
      color: #fbbf24; /* ì£¼í™© */
      font-weight: 600;
    }
    .c-string {
      color: #34d399; /* ì´ˆë¡ */
    }
    .c-number {
      color: #f472b6; /* í•‘í¬ */
    }
    .c-comment {
      color: #9ca3af; /* íšŒìƒ‰ */
      font-style: italic;
    }
    .c-grok {
      color: #8CE4FF; /* í•˜ëŠ˜ìƒ‰ */
    }
    .c-gtype {
      color: #fbbf24; /* ë…¸ë‘ */
    }
    .c-gvar {
      color: #FE6244; /* ë²„ê±´ë””ë”” */
    }
    .c-gextra {
      color: #F7A5A5; /* í•‘í¬ */
    }
  </style>
</head>
<body>
    
<div class="header-wrap">
  <div class="top-nav">
    <a href="https://etech-symantec.github.io/sysinfo" class="nav-btn">ğŸ§© Sysinfo ë¶„ì„</a>
    <a href="https://etech-symantec.github.io/isg" class="nav-btn">ğŸ” ISG ë¶„ì„</a>
    <a href="https://etech-symantec.github.io/trace" class="nav-btn">ğŸ“„ Trace ë¶„ì„</a>
    <a href="https://etech-symantec.github.io/sizing-sg" class="nav-btn">ğŸ“Š Sizing-SG ë³´ê¸°</a>
    <a href="https://etech-symantec.github.io/elk" class="nav-btn">ğŸ§¬ ELK ë¡œê·¸ ì„¤ì •</a>
  </div>

  <h1 class="dongle-regular">
    <div class="title-left">
      ELK logstash.conf ìƒì„±ê¸°<br>
      <span class="subtitle">by ì´í…Œí¬ì‹œìŠ¤í…œ</span>
    </div>
    <div class="date-container">
      <div class="version">ver.2025.11.13.01</div>
    </div>
  </h1>
</div>    
<main>
    <!-- ê³µí†µ ë³€ìˆ˜ ë°•ìŠ¤ -->
  <section class="card" id="common-box">
    <h3 class="title">Log ê³µí†µ ì„¤ì •</h3><div class="row">
  </div>
    <p class="help">ëª¨ë“  Typeì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë˜ëŠ” ê¸°ë³¸ ì„¤ì •ì…ë‹ˆë‹¤.</p>
    <div class="divider"></div>
    <div class="grid4">
      <div>
        <label>Input path prefix</label>
        <input type="text" id="common-path-prefix" value="/home/elk_ftp/" />
      </div>
      <div>
        <label>Sincedb path prefix</label>
        <input type="text" id="common-since-prefix" value="/var/lib/logstash/plugins/inputs/file/" />
      </div>
      <div>
        <label>Max open files</label>
        <input type="number" id="common-max-open" value="1000" min="1" />
      </div>
      <div>
        <label>Output hosts</label>
        <input type="text" id="common-output-hosts" value="http://localhost:9200" />
      </div>
    </div>
  </section>
    
  <!-- ìƒë‹¨: íƒ€ì… / ì¸ë±ìŠ¤ ê´€ë¦¬ -->
  <section class="card" id="panel">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
  <h3 class="title" style="margin:0;">Log Type ì„¤ì •</h3>
  <button class="btn sec" onclick="addType()">+ Type ì¶”ê°€</button>
</div>

  <div class="divider"></div>

  <div id="type-list" class="list"></div>
</section>

  <!-- í•˜ë‹¨: logstash.conf ë¯¸ë¦¬ë³´ê¸° -->
    <section class="card">
    
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 class="title" style="margin:0;">
          ìƒì„±ëœ <span class="mono">logstash.conf</span> ë¯¸ë¦¬ë³´ê¸°
        </h3>
        <div>
        <button class="btn sec" style="padding:2px 8px; font-size:14px;" onclick="buildConf()"><b>conf ìƒì„±/ê°±ì‹ </b></button>
        <button class="btn sec" style="padding:4px 8px; font-size:10px;"
                onclick="copyPreview()">
          ë³µì‚¬í•˜ê¸°
        </button>
        </div>
      </div>
    
      <div class="codebox" id="preview"></div>
    
    </section>

</main>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. ê³µí†µ í…œí”Œë¦¿ (type ê°œìˆ˜ ì œí•œ ì—†ìŒ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TEMPLATE = `input {
PLACEHOLDER_INPUT
}
filter {
PLACEHOLDER_FILTER
}
output {
PLACEHOLDER_OUTPUT
}`;

// input ë¸”ë¡
function tplInput(path, start, since, type, discover, maxOpen){
  return `file {
    path => "${path}"
    start_position => "${start}"
     sincedb_path => "${since}"
     type => "${type}"
     discover_interval => ${discover}
     max_open_files => ${maxOpen}
  }`;
}

// filter ë¸”ë¡ (typeë³„ if [type] == "X")
function tplFilter(type, grokArray, convertBlock){
  // cloud / edge êµ¬ë¶„ ì—†ì´, type ì´ë¦„ì— ë”°ë¼ date í¬ë§· íŒíŠ¸ë§Œ ë³€ê²½
  const isCloudLike = type.toLowerCase().includes('cloud');

  const dateAdd = isCloudLike
    ? `add_field => { "date" => "%{year}-%{month}-%{day}" }
      add_field => { "date-time" => "%{date} %{time}" }`
    : `add_field => { "date" => "%{day}/%{month}/%{year}" }
      add_field => { "date-time" => "%{day}/%{month}/%{year}:%{time_zone}" }`;

  const dateMatch = isCloudLike
    ? `match => ["date-time", "yyyy-MM-dd HH:mm:ss"]`
    : `match => ["date-time", "dd/MMM/yyyy:HH:mm:ss Z"]`;

  return `if [type] == "${type}" {
    if [message] =~ /^\\#.*/ {
      drop {}
    }
    grok {
      match => { "message" => ${grokArray} }
    }
    mutate {
      add_field => { "log_type" => "${type}" }
      ${dateAdd}
      remove_field => ["@timestamp", "message", "host", "path", "auth", "extra1", "tags", "@version", "_id", "_index", "_score", "_type", "year", "month", "day"]
    }${convertBlock}
    date {
      ${dateMatch}
      target => "@timestamp_log"
      timezone => "Asia/Seoul"
    }
  }`;
}

// output ë¸”ë¡ (type == index)
function tplOutput(type, hosts){
  return `if [type] == "${type}" {
    elasticsearch {
      hosts => [${hosts}]
      index => "${type}"
    }
  }`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2. Type ì¹´ë“œ ì¶”ê°€/ì‚­ì œ (ìƒë‹¨ íŒ¨ë„ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let typeSeq = 0;

// ê³µí†µ input ì„¤ì • (ì›í•˜ë©´ HTMLì— ì…ë ¥ì°½ ì¶”ê°€í•´ì„œ ì½ì–´ì˜¤ë©´ ë¨)
const DEFAULT_PATH_PREFIX  = "/home/elk_ftp/";
const DEFAULT_SINCE_PREFIX = "/var/lib/logstash/plugins/inputs/file/";
const DEFAULT_MAX_OPEN     = 1000;
const DEFAULT_HOSTS        = ["http://localhost:9200"];

function addType(){
  const host = document.getElementById('type-list');
  const id = `type-${++typeSeq}`;
  const div = document.createElement('div');
  div.className = 'idx type-card collapsed';
  div.dataset.id = id;

    
    div.innerHTML = `
      <div class="type-card-header">
          <div onclick="toggleTypeBody('${id}')" style="flex:1; cursor:pointer;">
            <h4 style="display: flex; align-items: center; justify-content: space-between;">
              <span><span class="mono">type</span> <span id="${id}-num"></span> : <span id="${id}-title">(ë¯¸ì§€ì •)</span></span>
              <span class="small muted">ì ‘ê¸°/í¼ì¹˜ê¸° â–¾ã€€</span>
            </h4>
          </div>
          
          <button class="btn ghost"
                  style="padding:4px 6px; font-size:8px;"
                  onclick="removeType('${id}')"
                  title="ì‚­ì œ">
              âœ•
          </button>
        </div>

      
      <div class="type-card-body">
        <div class="grid5">
          <div>
            <label>type ì´ë¦„</label>
            <input type="text"
                   id="${id}-name"
                   placeholder="ì˜ˆ: cloud, edge, proxy01 ..."
                   oninput="updateTypeTitle('${id}', this.value)" />
          </div>
          <div>
            <label>start_position</label>
            <select id="${id}-start">
              <option value="beginning" selected>beginning</option>
              <option value="end">end</option>
            </select>
          </div>
          <div>
            <label>path suffix</label>
            <input type="text" id="${id}-path" value="*.log" />
          </div>
          <div>
            <label>sincedb suffix</label>
            <input type="text" id="${id}-since" value=".sincedb_cloud" />
          </div>
          <div>
            <label>discover_interval</label>
            <input type="number" id="${id}-discover" value="5" min="1" />
          </div>
        </div>
    
        <label>ELFF í¬ë§· ì…ë ¥</label>
        <textarea id="${id}-elff" placeholder="date time time-taken c-ip ..." oninput="autoElffToGrok('${id}')"></textarea>
        <label>ìƒì„±ëœ Grok íŒ¨í„´</label>
        <textarea id="${id}-grok-view" readonly></textarea>
        
        <button class="grok-toggle-btn" type="button" onclick="toggleGrokTable('${id}')">
          íŒ¨í„´ ìƒì„¸ ë³´ê¸° <span id="${id}-grok-toggle">â–¾</span>
        </button>

        <div class="table" id="${id}-table" style="display:none">
        
          <table>
            <thead>
              <tr>
                <th>ìˆœì„œ</th>
                <th>ELFF í† í°</th>
                <th>ì ìš© Grok í‘œí˜„ì‹</th>
              </tr>
            </thead>

            <tbody id="${id}-rows"></tbody>
          </table>
        </div>
        <input type="hidden" id="${id}-grok" />
      </div>
    `;
  host.appendChild(div);
  renumberTypes();
}
function renumberTypes(){
  const cards = [...document.querySelectorAll('#type-list .type-card')];
  cards.forEach((card, idx)=>{
    const id = card.dataset.id;
    const span = document.getElementById(id + '-num');
    if(span) span.textContent = idx + 1;
  });
}




function removeType(id){
  const el = document.querySelector(`.type-card[data-id="${id}"]`);
  if(el) el.remove();
  renumberTypes();
}

    
    
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ELFF â†’ Grok ê¸°ë³¸ ë§¤í•‘ / íƒ€ì… ì¶”ì •
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAP = {
  'date': '%{YEAR:year}-%{MONTHNUM:month}-%{MONTHDAY:day}',
  'time': '%{TIME:time}',
  'time-taken': '%{NUMBER:time_taken:int}',
  'c-ip': '%{IP:c_ip}',
  'cs-username': '%{NOTSPACE:cs_username}',
  'cs-auth-group': '%{NOTSPACE:cs_auth_group}',
  's-supplier-name': '%{NOTSPACE:s_supplier_name}',
  's-supplier-ip': '(%{IP:s_supplier_ip}|-)',
  's-supplier-country': '%{QUOTEDSTRING:s_supplier_country}',
  's-supplier-failures': '%{NOTSPACE:s_supplier_failures}',
  'x-exception-id': '%{NOTSPACE:x_exception_id}',
  'sc-filter-result': '%{NOTSPACE:sc_filter_result}',
  'cs-categories': '%{QUOTEDSTRING:cs_categories}',
  'sc-status': '%{NOTSPACE:sc_status}',
  's-action': '%{NOTSPACE:s_action}',
  'cs-method': '%{WORD:cs_method}',
  'rs(Content-Type)': '%{NOTSPACE:rs_Content_Type}',
  'cs-uri-scheme': '%{NOTSPACE:cs_uri_scheme}',
  'cs-host': '%{NOTSPACE:cs_host}',
  'cs-uri-port': '%{NUMBER:cs_uri_port}',
  'cs-uri-extension': '%{NOTSPACE:cs_uri_extension}',
  'cs(User-Agent)': '(%{QUOTEDSTRING:cs_User_Agent}|-)',
  's-ip': '%{IP:s_ip}',
  'sc-bytes': '%{NUMBER:sc_bytes:int}',
  'cs-bytes': '%{NUMBER:cs_bytes:int}',
  'x-virus-id': '%{NOTSPACE:x_virus_id}',
  'cs-threat-source': '%{NOTSPACE:cs_threat_source}',
  'cs-threat-id': '%{NOTSPACE:cs_threat_id}',
  'rs-threat-source': '%{NOTSPACE:rs_threat_source}',
  'rs-threat-id': '%{NOTSPACE:rs_threat_id}',
  'x-rs-certificate-observed-errors': '%{NOTSPACE:x_rs_certificate_observed_errors}',
  'x-cs-ocsp-error': '%{NOTSPACE:x_cs_ocsp_error}',
  'x-rs-ocsp-error': '%{NOTSPACE:x_rs_ocsp_error}',
  'x-rs-connection-negotiated-cipher-strength': '%{NOTSPACE:x_rs_connection_negotiated_cipher_strength}',
  'x-rs-certificate-hostname': '%{NOTSPACE:x_rs_certificate_hostname}',
  'x-rs-certificate-hostname-category': '"%{DATA:x_rs_certificate_hostname_category}"',
  'cs-threat-risk': '%{NOTSPACE:cs_threat_risk}',
  'x-rs-certificate-hostname-threat-risk': '%{NOTSPACE:x_rs_certificate_hostname_threat_risk}',
  'x-bluecoat-access-security-policy-action': '%{NOTSPACE:x_bluecoat_access_security_policy_action}',
  'x-bluecoat-access-security-policy-reason': '%{NOTSPACE:x_bluecoat_access_security_policy_reason}'
};


function buildConf(){
    
    // ê³µí†µ prefix ìœ íš¨ì„± ê²€ì‚¬
    function markInvalid(id, condition){
        const el = document.getElementById(id);
        if(!el) return;
        if(condition){
            el.style.border = "2px solid #ef4444";   // ë¹¨ê°„ìƒ‰ ê°•ì¡°
        }else{
            el.style.border = "";                    // ì›ìƒë³µêµ¬
        }
    }
    
    const cp = document.getElementById('common-path-prefix').value.trim();
    const cs = document.getElementById('common-since-prefix').value.trim();
    
    markInvalid('common-path-prefix',  cp === "");
    markInvalid('common-since-prefix', cs === "");
    
    if(cp === "" || cs === ""){
        alert("ê³µí†µ prefixëŠ” ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    
  const typeCards = [...document.querySelectorAll('#type-list .type-card')];
  if(typeCards.length === 0){
    alert('ìµœì†Œ 1ê°œì˜ typeì„ ì¶”ê°€í•˜ì„¸ìš”.');
    return;
  }
  
  // ğŸ”¥ ê³µí†µ ë°•ìŠ¤ ë³€ìˆ˜ ì½ì–´ì˜¤ê¸°
  let DEFAULT_PATH_PREFIX  = document.getElementById('common-path-prefix').value.trim();
    let DEFAULT_SINCE_PREFIX = document.getElementById('common-since-prefix').value.trim();
    
    // ê³µí†µ prefix ìë™ / ì¶”ê°€
    if(DEFAULT_PATH_PREFIX && !DEFAULT_PATH_PREFIX.endsWith('/')) {
        DEFAULT_PATH_PREFIX += '/';
    }
    if(DEFAULT_SINCE_PREFIX && !DEFAULT_SINCE_PREFIX.endsWith('/')) {
        DEFAULT_SINCE_PREFIX += '/';
    }

  const DEFAULT_MAX_OPEN     = parseInt(document.getElementById('common-max-open').value.trim() || "1000", 10);


  // output hosts ë°°ì—´
  const hosts = DEFAULT_HOSTS;
  const maxOpen = DEFAULT_MAX_OPEN;

  const mkGrokArray = (parts) => {
    if(!parts || parts.length === 0) return '["%{GREEDYDATA:message}"]';
    // í•œ typeë‹¹ 1ì¤„ íŒ¨í„´ìœ¼ë¡œ í•©ì¹˜ëŠ” ë°©ì‹
    return '["' + escapeQuotes(parts.join(' ')) + '"]';
  };

  const mkConvert = (typesMap) => {
    const conv = [];
    Object.entries(typesMap || {}).forEach(([token, type]) => {
      const fieldName = guessFieldName(token);
      if(!fieldName) return;
      if(type === 'int' || type === 'float' || type === 'boolean'){
        conv.push(`"${fieldName}" => "${type}"`);
      }
    });
    if(conv.length === 0) return '';
    return `\n    mutate {\n      convert => { ${conv.join(' ')} }\n    }`;
  };

  let inputs = [], filters = [], outputs = [];

  typeCards.forEach(card => {
    const id   = card.dataset.id;
    const type = document.getElementById(id+'-name').value.trim();
    const start = document.getElementById(id+'-start').value;
    const pathS = document.getElementById(id+'-path').value.trim();
    const sinceS = document.getElementById(id+'-since').value.trim();
    const disc  = document.getElementById(id+'-discover').value.trim() || '5';

    if(!type) return;

    // input
    const fullPath  = DEFAULT_PATH_PREFIX  + pathS;
    const fullSince = DEFAULT_SINCE_PREFIX + sinceS;
    inputs.push(
      tplInput(fullPath, start, fullSince, type, disc, maxOpen)
    );

    // grok/convert
    let data = {parts:[], types:{}};
    try{
      data = JSON.parse(document.getElementById(id+'-grok').value || '{}');
    }catch(e){}
    const grokArray    = mkGrokArray(data.parts);
    const convertBlock = mkConvert(data.types);

    filters.push(
      tplFilter(type, grokArray, convertBlock)
    );

    // output (index = type)
    outputs.push(
      tplOutput(type, hosts)
    );
  });

  if(inputs.length === 0){
    alert('type ì´ë¦„ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  const conf = TEMPLATE
    .replace('PLACEHOLDER_INPUT',  inputs.join('\n'))
    .replace('PLACEHOLDER_FILTER', filters.join('\nelse {\n  }  # dummy\n') ) // else ì‚¬ì´ì— êµ¬ë¶„ìš©
    .replace('PLACEHOLDER_OUTPUT', outputs.join('\n  else {\n  }  # dummy\n'));

  document.getElementById('preview').innerHTML = highlightLogstash(conf);

}


function defaultType(token){
  const m = { 'time-taken':'int','cs-uri-port':'int','sc-bytes':'int','cs-bytes':'int' };
  if(m[token]) return m[token];
  if(token.endsWith('-ip')) return 'ip';
  return 'string';
}


// ê³µí†µ: ELFF â†’ Grok ë³€í™˜ ë° í…Œì´ë¸” ë Œë”ë§
function elffToGrok(id){
  const raw = document.getElementById(id+'-elff').value.trim();
  if(!raw){ alert('ELFF í¬ë§·ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const tokens = raw.split(/\s+/);
  renderGrokTable(id, tokens, null);
}

function renderGrokTable(id, tokens, existing){
  const rows = document.getElementById(id+'-rows');
  if(!rows) return;
  rows.innerHTML='';
  
  let parts = [];
  let types = existing?.types || {};
  
  tokens.forEach((t, i)=>{
    // ğŸ”¹ ê¶Œì¥ê°’
    const recommended = MAP[t] || `%{NOTSPACE:${t.replace(/[^a-zA-Z0-9_]/g,'_')}}`;

    // ğŸ”¹ ì ìš©ê°’(ìˆ˜ì • ê°€ëŠ¥)
    const applied = existing?.parts?.[i] || recommended;

    parts.push(applied);
    
    const isSame = (applied.trim() === recommended.trim());
    const bg = isSame ? "background:#e6ffed;" : "";   // ì—°í•œ ì´ˆë¡ ë°°ê²½
  
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="small muted">${i + 1}</td>
      <td class="mono">${t}</td>
      <td>
        <input type="text"
               value="${applied.replace(/"/g, '&quot;')}"
               style="width:100%; ${bg}"
               oninput="onGrokCell('${id}', ${i}, this.value)" />
      </td>
    `;

    rows.appendChild(tr);
    
  });
  document.getElementById(id+'-grok').value = JSON.stringify({parts, types:collectTypes(id)});
}



function onGrokCell(id, idx, value){
  const hidden = document.getElementById(id+'-grok');
  if(!hidden) return;

  let data={parts:[],types:{}};
  try{ data = JSON.parse(hidden.value||'{}'); }catch(e){}

  if(!data.parts) data.parts=[];
  data.parts[idx] = value;
  saveGrokState(id, data);
// ğŸ”¥ textareaì— ì¦‰ì‹œ ë°˜ì˜
  document.getElementById(id+'-grok-view').value = data.parts.join(' ');

  // ğŸ”¥ ê¶Œì¥ê°’ê³¼ ë¹„êµí•´ì„œ input ìƒ‰ ì‹¤ì‹œê°„ ê°±ì‹ 
  const token = document.getElementById(id+'-rows')
                  .children[idx]
                  .children[1]
                  .textContent;

  const recommended = MAP[token] || `%{NOTSPACE:${token.replace(/[^a-zA-Z0-9_]/g,'_')}}`;

  const inputEl = document.getElementById(id+'-rows')
                  .children[idx]
                  .children[2]
                  .querySelector('input');

  if(inputEl){
    if(value.trim() === recommended.trim()){
      inputEl.style.background = "#e6ffed";   // ì—°í•œ ì´ˆë¡
    } else {
      inputEl.style.background = "";          // ê¸°ë³¸
    }
  }
}

function onTypeCell(id, token, type){
  const hidden = document.getElementById(id+'-grok');
  if(!hidden) return;
  let data={parts:[],types:{}};
  try{ data = JSON.parse(hidden.value||'{}'); }catch(e){}
  if(!data.types) data.types={};
  data.types[token]=type;
  saveGrokState(id, data);
}
function collectTypes(id){
  const tbody = document.getElementById(id+'-rows');
  const types={};
  if(!tbody) return types;
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const token = tr.children[1].textContent;
    const type  = tr.querySelector('select').value;
    types[token]=type;
  });
  return types;
}
function saveGrokState(id, data){
  const hidden = document.getElementById(id+'-grok');
  if(hidden) hidden.value = JSON.stringify(data);
}

function escapeQuotes(s){
  return s.replace(/\\/g,'\\\\').replace(/"/g,'\\"');
}

function guessFieldName(token){
  if(MAP[token]){
    const m = MAP[token].match(/%\{[^:]+:([^}]+)\}/);
    if(m) return m[1];
  }
  return token.replace(/[^a-zA-Z0-9_]/g,'_');
}

function toggleTypeBody(id){
  const card = document.querySelector(`.type-card[data-id="${id}"]`);
  if(!card) return;
  card.classList.toggle('collapsed');
}

function updateTypeTitle(id, value){
  const span = document.getElementById(id + '-title');
  if(!span) return;
  span.textContent = value && value.trim() ? value.trim() : '(ë¯¸ì§€ì •)';
}

function openMappingModal(){
  const m = document.getElementById('mapping-modal');
  if(!m) return;

  const body = document.getElementById('mapping-body');
  body.innerHTML = "";  // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ

  // MAP ê°ì²´ì˜ ëª¨ë“  key/valueë¥¼ í…Œì´ë¸”ë¡œ ì¶œë ¥
  Object.entries(MAP).forEach(([token, pattern]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><code>${token}</code></td>
      <td><code>${pattern}</code></td>
    `;
    body.appendChild(tr);
  });

  m.style.display = 'flex';
}


function closeMappingModal(e){
  const m = document.getElementById('mapping-modal');
  if(m) m.style.display = 'none';
}

function autoElffToGrok(id){
  const raw = document.getElementById(id+'-elff').value.trim();
  if(!raw){
    document.getElementById(id+'-grok-view').value = "";
    document.getElementById(id+'-table').style.display = "none";
    return;
  }

  const tokens = raw.split(/\s+/);

  // ğŸ”¥ MAP ê¸°ë°˜ ê¶Œì¥ê°’ìœ¼ë¡œ íŒ¨í„´ ìƒì„±
  const parts = tokens.map(t =>
    MAP[t] || `%{NOTSPACE:${t.replace(/[^a-zA-Z0-9_]/g,'_')}}`
  );

  // Grok íŒ¨í„´ textarea ë°˜ì˜
  document.getElementById(id+'-grok-view').value = parts.join(' ');

  // type ì¹´ë“œ ìˆ¨ì€ ê°’ ì €ì¥
  const data = { parts, types:{} };
  document.getElementById(id+'-grok').value = JSON.stringify(data);

  // ğŸ”¥ MAP ê¸°ë°˜ ê¶Œì¥ íŒ¨í„´ í…Œì´ë¸”ë„ ì¦‰ì‹œ ìƒì„±
  renderGrokTable(id, tokens, data);
}

function toggleGrokTable(id){
  const tbl = document.getElementById(id+'-table');
  const icon = document.getElementById(id+'-grok-toggle');
  if(!tbl || !icon) return;

  const isCollapsed = tbl.style.display === "none" || tbl.style.display === "";

  if(isCollapsed){
    tbl.style.display = "block";
    icon.textContent = "â–´";   // í¼ì³ì¡Œì„ ë•Œ ì•„ì´ì½˜
  } else {
    tbl.style.display = "none";
    icon.textContent = "â–¾";   // ì ‘í˜”ì„ ë•Œ ì•„ì´ì½˜
  }
}
function copyPreview() {
  const txt = document.getElementById("preview").textContent;
  if (!txt.trim()) {
    alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.clipboard.writeText(txt)
    .then(() => alert("logstash.conf ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
    .catch(() => alert("ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
}

function highlightLogstash(conf) {
  // ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € HTML ì´ìŠ¤ì¼€ì´í”„
  let html = escapeHTML(conf);

  // 1) ë¬¸ìì—´
  html = html.replace(/"([^"]*)"/g,
    match => `<span class="c-string">${match}</span>`
  );
  // 2) ìˆ«ì
  html = html.replace(/\b\d+\b/g,
    match => `<span class="c-number">${match}</span>`
  );
  // 3) í‚¤ì›Œë“œ
  html = html.replace(
    /\b(path|type|sincedb_path|start_position|discover_interval|max_open_files|hosts|index)\b/g,
    match => `<span class="c-key">${match}</span>`
  );
  // 4) ë¸”ë¡ëª…
  html = html.replace(/\b(input|filter|output)\b/g,
    match => `<span class="c-block">${match}</span>`
  );
  // 5) Grok íŒ¨í„´: %{TYPE:FIELD[:EXTRA]}
  html = html.replace(
    /%\{([A-Za-z0-9_]+):([A-Za-z0-9_]+)(?::([A-Za-z0-9_]+))?\}/g,
    (match, gtype, gvar, gextra) => {
      return `<span class="c-grok">%{` +
             `<span class="c-gtype">${gtype}</span>:` +
             `<span class="c-gvar">${gvar}</span>` +
             (gextra ? `:<span class="c-gextra">${gextra}</span>` : "") +
             `}</span>`;
    }
  );

  return html;
}

function escapeHTML(str){
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}


// ì´ˆê¸° ìƒíƒœ: type 1ê°œ ìƒ˜í”Œ + ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
addType();

</script>
</body>
</html>
